<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ICU Bed Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 20px; }
    h1 { text-align: center; }
    .room-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
    .room { background: white; border: 1px solid #ccc; border-radius: 8px; width: 300px; flex: 1 1 300px; box-shadow: 2px 2px 8px rgba(0,0,0,0.1); overflow: hidden; }
    .room-header { cursor: pointer; background: #eee; padding: 10px; font-weight: bold; border-bottom: 1px solid #ccc; }
    .room-content { display: none; padding: 10px; }
    .bed { display: flex; flex-direction: column; border-left: 10px solid #ccc; padding: 10px; margin-bottom: 10px; background: #f0f0f0; border-radius: 5px; }
    .bed input, .bed select { margin-top: 5px; padding: 4px; font-size: 14px; }
    .bed button { margin-top: 5px; font-size: 13px; padding: 5px 8px; cursor: pointer; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%; }
    .modal input { display: block; margin-bottom: 10px; width: 100%; padding: 8px; }
    .modal button { margin-top: 10px; }
  </style>
</head>
<body>

<h1>üè• ICU Bed Tracker <button onclick="document.getElementById('adminModal').style.display='flex'">‚öôÔ∏è Admin Panel</button></h1>

<div id="adminModal" class="modal">
  <div class="modal-content">
    <h3>Admin Panel</h3>
    <input type="password" id="adminPassInput" placeholder="Enter Admin Password">
    <div id="adminActions" style="display:none">
      <input type="text" id="newRoomName" placeholder="Room name">
      <input type="text" id="newRoomDesc" placeholder="Room description">
      <input type="number" id="newRoomBeds" placeholder="Number of beds">
      <button onclick="addRoom()">‚ûï Add Room</button>
      <input type="text" id="deleteRoomName" placeholder="Room to delete">
      <button onclick="deleteRoom()">‚ùå Delete Room</button>
    </div>
    <button onclick="verifyPassword()">Login</button>
    <button onclick="document.getElementById('adminModal').style.display='none'">Close</button>
  </div>
</div>

<div class="room-container" id="rooms"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAhoL_pZudfm53_6tuzgoCGsWOagL6AjZ8",
  authDomain: "icubedtracker.firebaseapp.com",
  projectId: "icubedtracker",
  storageBucket: "icubedtracker.appspot.com",
  messagingSenderId: "237624609130",
  appId: "1:237624609130:web:0f39d97d24443907f1bd13"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let isAdmin = false;

function verifyPassword() {
  const input = document.getElementById("adminPassInput").value;
  db.collection("config").doc("admin").get().then(doc => {
    if (input === doc.data()?.password) {
      isAdmin = true;
      document.getElementById("adminActions").style.display = "block";
      alert("‚úÖ Access granted");
    } else alert("‚ùå Wrong password");
  });
}

function loadRooms() {
  db.collection("rooms").get().then(snapshot => {
    snapshot.forEach(doc => {
      const roomId = doc.id;
      const data = doc.data();
      db.collection("rooms").doc(roomId).collection("beds").get().then(bedSnap => {
        const beds = [];
        bedSnap.forEach(b => beds.push({ id: b.id, ...b.data() }));
        renderRoom(roomId, data.description, beds);
      });
    });
  });
}

function renderRoom(name, desc, beds) {
  const div = document.createElement("div");
  div.className = "room";
  div.innerHTML = `<div class="room-header">${name}</div><div class="room-content"><p>${desc || ''}</p></div>`;
  const content = div.querySelector(".room-content");
  div.querySelector(".room-header").onclick = () => {
    content.style.display = content.style.display === "none" ? "block" : "none";
  };
  beds.forEach((bed, index) => {
    const bedDiv = document.createElement("div");
    bedDiv.className = "bed";
    bedDiv.style.borderLeftColor = bed.color || "#ccc";
    bedDiv.innerHTML = `
      <strong>Bed ${index + 1}</strong>
      <input value="${bed.status}" readonly disabled />
      <input value="${bed.notes}" placeholder="Notes" oninput="noteChanged(this)">
      <select onchange="colorChanged(this)">
        <option value="">None</option>
        <option value="green" ${bed.color==="green"?'selected':''}>Green</option>
        <option value="yellow" ${bed.color==="yellow"?'selected':''}>Yellow</option>
        <option value="red" ${bed.color==="red"?'selected':''}>Red</option>
      </select>
      <button onclick="saveBed('${name}', '${bed.id}', this)">üíæ Save</button>
      <button onclick="clearBed('${name}', '${bed.id}', this)">‚ùå Clear</button>
    `;
    content.appendChild(bedDiv);
  });
  document.getElementById("rooms").appendChild(div);
}

function noteChanged(input) {
  const parent = input.parentElement;
  const status = parent.children[1];
  const color = parent.children[3];
  if (input.value.trim()) {
    status.value = "Occupied";
    color.value = "red";
    parent.style.borderLeftColor = "red";
  } else {
    status.value = "Empty";
    color.value = "green";
    parent.style.borderLeftColor = "green";
  }
}

function colorChanged(select) {
  select.parentElement.style.borderLeftColor = select.value || "#ccc";
}

function saveBed(roomId, bedId, btn) {
  const parent = btn.parentElement;
  const status = parent.children[1].value;
  const notes = parent.children[2].value;
  const color = parent.children[3].value;
  db.collection("rooms").doc(roomId).collection("beds").doc(bedId).set({ status, notes, color })
    .then(() => {
      btn.innerText = "‚úÖ Saved";
      setTimeout(() => btn.innerText = "üíæ Save", 1500);
    });
}

function clearBed(roomId, bedId, btn) {
  if (!confirm("Clear this bed?")) return;
  db.collection("rooms").doc(roomId).collection("beds").doc(bedId).set({ status: "Empty", notes: "", color: "green" })
    .then(() => location.reload());
}

function addRoom() {
  const name = document.getElementById("newRoomName").value.trim();
  const desc = document.getElementById("newRoomDesc").value.trim();
  const count = parseInt(document.getElementById("newRoomBeds").value);
  if (!name || !count) return alert("Fill all room fields");
  db.collection("rooms").doc(name).set({ description: desc, beds_count: count }).then(() => {
    const promises = [];
    for (let i = 1; i <= count; i++) {
      const bedRef = db.collection("rooms").doc(name).collection("beds").doc();
      promises.push(bedRef.set({ status: "Empty", notes: "", color: "green" }));
    }
    return Promise.all(promises);
  }).then(() => location.reload());
}

function deleteRoom() {
  const name = document.getElementById("deleteRoomName").value.trim();
  if (!name || !confirm("Delete room " + name + "?")) return;
  db.collection("rooms").doc(name).collection("beds").get().then(snapshot => {
    const deletions = snapshot.docs.map(doc => doc.ref.delete());
    return Promise.all(deletions);
  }).then(() => db.collection("rooms").doc(name).delete()).then(() => location.reload());
}

window.onload = loadRooms;
</script>

</body>
</html>
