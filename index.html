<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ICU Bed Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 0;
      padding: 0;
    }
    h1 {
      text-align: center;
      font-size: 22px;
      margin: 10px 0 10px 0;
    }
    .layout {
      display: flex;
      min-height: 100vh;
      max-width: 1300px;
      margin: 0 auto;
    }
    .sidebar {
      width: 230px;
      background: #fff;
      border-left: 1px solid #eee;
      display: flex;
      flex-direction: column;
      padding: 0 0 20px 0;
      box-shadow: -2px 0 10px 0 rgba(0,0,0,0.04);
      z-index: 20;
    }
    .sidebar h2 {
      font-size: 17px;
      font-weight: bold;
      margin: 20px 0 15px 0;
      text-align: center;
      letter-spacing: 1px;
      color: #444;
    }
    .room-list {
      flex: 1;
      overflow-y: auto;
    }
    .room-list button {
      width: 95%;
      margin: 4px auto;
      display: block;
      padding: 10px 12px;
      font-size: 16px;
      border: none;
      border-radius: 7px;
      background: #f3f3f3;
      color: #333;
      text-align: left;
      cursor: pointer;
      transition: background 0.18s;
    }
    .room-list button.selected,
    .room-list button:hover {
      background: #cceaff;
      color: #00619b;
      font-weight: bold;
    }

    .main-area {
      flex: 1;
      min-width: 0;
      padding: 20px 12px 32px 12px;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }
    .room-view {
        width: 100%;
        max-width: 470px;
        background: #fff;
        border-radius: 10px;
        box-shadow: 2px 2px 18px rgba(0,0,0,0.07);
        border: 1px solid #ececec;
        padding: 18px 15px;
        box-sizing: border-box;  /* Added: Ensure padding fits in width */
        }
    .room-header-title {
      font-size: 22px;
      font-weight: bold;
      margin-bottom: 6px;
      color: #0471c4;
      letter-spacing: 1px;
    }
    .room-header-desc {
      font-size: 15px;
      margin-bottom: 3px;
      color: #222;
    }
    .room-header-info {
      font-size: 14px;
      color: #5a5a5a;
      margin-bottom: 13px;
    }
    .bed {
        position: relative;
        border-left: 7px solid #ccc;
        background: #f3f7fa;
        border-radius: 9px;
        margin-bottom: 18px;
        padding: 14px 16px 13px 18px;
        transition: background-color 0.28s;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    .bed.changed {
      background-color: #fff3cd;
    }
    .bed input,
    .bed select {
    width: 100%;
    box-sizing: border-box;
    margin-top: 2px;
    }
    .bed .remove-bed-btn {
        position: absolute;
        top: 12px;
        right: 12px;
        cursor: pointer;
        color: #fff;
        background: #be2c2c;
        font-weight: bold;
        border: none;
        font-size: 17px;
        border-radius: 50%;
        width: 28px;
        height: 28px;
        line-height: 28px;
        text-align: center;
        box-shadow: 0 2px 8px #e3c5c5;
        transition: background 0.18s, box-shadow 0.15s, transform 0.1s;
        z-index: 2;
        outline: none;
        }
        .bed .remove-bed-btn:hover,
        .bed .remove-bed-btn:focus {
        background: #e84141;
        box-shadow: 0 4px 16px #ffdadc;
        transform: scale(1.08);
        }
    .bed button {
      margin-top: 8px;
      font-size: 15px;
      padding: 7px;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #007bff;
      color: white;
      margin-right: 8px;
    }
    .bed button:last-child {
      background: #dc3545;
      margin-right: 0;
    }
    .bed button:hover { filter: brightness(0.92); }
    .bed label {
        font-size: 14px;
        color: #444;
        margin-bottom: 1px;
        margin-top: 0;
        }

        .bed strong.bed-title {
        margin-bottom: 5px;
        font-size: 17px;
        color: #0471c4;
        }

        .bed .admin-buttons {
        margin-top: 10px;
        }
    .remove-bed-btn {
      position:absolute; top:8px; right:10px; cursor:pointer; color:#c00; font-weight:bold; background: none; border: none; font-size: 18px;
    }
    .admin-buttons {
      margin-top: 8px;
      display: flex;
      gap: 9px;
    }
    .modal {
  display: none;
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(0,0,0,0.5);
  justify-content: center;
  align-items: center;
  z-index: 999;
}
.modal-content {
  background: white;
  padding: 26px 18px 22px 18px;
  border-radius: 14px;
  max-width: 420px;
  width: 96vw;
  box-shadow: 0 8px 32px rgba(0,0,0,0.20);
  margin: 0 auto;
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: stretch;
}

.admin-buttons button {
  background: #735bf2;
  color: #fff;
}
.admin-buttons button:hover {
  background: #4233a3;
}
#adminModal button[onclick*='Close'] {
  background: #f6f6f6;
  color: #444;
  border: none;
  border-radius: 6px;
  margin-top: 6px;
  padding: 10px;
  font-size: 15px;
  font-weight: 600;
  cursor: pointer;
  box-shadow: 0 1px 4px #eee;
  transition: background 0.18s, color 0.18s;
}

#adminModal button[onclick*='Close']:hover,
#adminModal button[onclick*='Close']:focus {
  background: #eaeaea;
  color: #d11d1d;
}
#adminModal h3 {
  text-align: center;
  margin-bottom: 12px;
  font-size: 21px;
}
#adminActions, #nonAdminActions {
  display: flex;
  flex-direction: column;
  gap: 11px;
}
#adminActions input, #adminActions button,
#nonAdminActions input, #nonAdminActions button {
  font-size: 15px;
  padding: 9px;
  border-radius: 6px;
  border: 1px solid #bbb;
  margin: 0;
}
#adminActions hr { margin: 9px 0; border: none; border-top: 1px solid #eee; }
#adminActions button,
#nonAdminActions button {
  border: none;
  font-weight: bold;
  background: #586af7;
  color: #fff;
  cursor: pointer;
  transition: background 0.19s;
}
#adminActions button:hover,
#nonAdminActions button:hover {
  background: #2743b6;
}
#adminActions button[onclick*="deleteRoom"] {
  background: #dc3545;
}
#adminActions button[onclick*="deleteRoom"]:hover {
  background: #b52c2c;
}
#adminActions button[onclick*="Logout"] {
  background: #ccc;
  color: #2d2d2d;
}
#adminActions button[onclick*="Logout"]:hover {
  background: #bbb;
}
#adminModal button[onclick*='Close'] {
  background: #ddd;
  color: #222;
  margin-top: 8px;
}
#adminModal button[onclick*='Close']:hover {
  background: #bcbcbc;
}
    #toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.85);
      color: white;
      padding: 11px 22px;
      border-radius: 6px;
      display: none;
      z-index: 1000;
      font-size: 16px;
    }
    .mobile-room-select {
      display: none;
      width: 100%;
      padding: 12px 0 6px 0;
      background: #fff;
      border-bottom: 1px solid #e2e2e2;
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .mobile-room-select select {
      width: 97%;
      margin: 0 auto;
      display: block;
      font-size: 17px;
      border-radius: 8px;
      padding: 10px 6px;
      border: 1px solid #b4b4b4;
    }
    /* Responsive: mobile < 750px */
    @media screen and (max-width: 750px) {
      .layout { flex-direction: column-reverse; }
      .sidebar { display: none; }
      .main-area { width: 100%; padding: 11px 2px 36px 2px; }
      .mobile-room-select { display: block; }
      .room-view { box-shadow: none; border: none; border-radius: 0; padding: 8px 2px; }
    }
  </style>
</head>
<body>

<h1>üè• ICU Bed Tracker <button onclick="document.getElementById('adminModal').style.display='flex'">‚öôÔ∏è Admin Panel</button></h1>

<div id="adminModal" class="modal" style="display:none">
  <div class="modal-content">
    <h3>Admin Panel</h3>
    <div id="adminActions" style="display:none">
      <input type="text" id="newRoomName" placeholder="Room name" />
      <input type="text" id="newRoomDesc" placeholder="Room description" />
      <input type="number" id="newRoomBeds" placeholder="Number of beds" />
      <button onclick="addRoom()">‚ûï Add Room</button>
      <hr />
      <input type="text" id="deleteRoomName" placeholder="Room to delete" />
      <button onclick="deleteRoom()">‚ùå Delete Room</button>
      <hr />
      <button onclick="logoutAdmin()">Logout</button>
    </div>
    <div id="nonAdminActions" style="display:none">
      <input type="password" id="adminPassInput" placeholder="Enter Admin Password" />
      <button onclick="verifyPassword()">Login</button>
    </div>
    <button onclick="document.getElementById('adminModal').style.display='none'">Close</button>
  </div>
</div>

<div id="toast"></div>

<div class="mobile-room-select" id="mobileRoomSelect" style="display:none;">
  <select id="mobileRoomDropdown" onchange="selectRoom(this.value)"></select>
</div>
<div class="layout">
  <div class="main-area" id="mainArea"></div>
  <aside class="sidebar" id="sidebar">
    <h2>Rooms</h2>
    <div class="room-list" id="roomList"></div>
  </aside>
</div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAhoL_pZudfm53_6tuzgoCGsWOagL6AjZ8",
  authDomain: "icubedtracker.firebaseapp.com",
  projectId: "icubedtracker",
  storageBucket: "icubedtracker.firebasestorage.app",
  messagingSenderId: "237624609130",
  appId: "1:237624609130:web:0f39d97d24443907f1bd13"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let isAdmin = localStorage.getItem("isAdmin") === "true";
if (isAdmin) document.addEventListener("DOMContentLoaded", () => document.getElementById("adminActions").style.display = "block");

let clientId = localStorage.getItem("clientId");
if (!clientId) {
  clientId = Math.random().toString(36).substring(2, 15);
  localStorage.setItem("clientId", clientId);
}

function toast(msg) {
  const t = document.getElementById("toast");
  t.innerText = msg;
  t.style.display = "block";
  setTimeout(() => (t.style.display = "none"), 3200);
}
function updateAdminPanelVisibility() {
  if (isAdmin) {
    document.getElementById("adminActions").style.display = "flex";
    document.getElementById("nonAdminActions").style.display = "none";
  } else {
    document.getElementById("adminActions").style.display = "none";
    document.getElementById("nonAdminActions").style.display = "flex";
  }
}

// Call on page load and after login/logout:
document.addEventListener("DOMContentLoaded", updateAdminPanelVisibility);

// In verifyPassword(), after successful login:
function verifyPassword() {
  const input = document.getElementById("adminPassInput").value;
  db.collection("config").doc("admin").get().then(doc => {
    if (input === doc.data()?.password) {
      isAdmin = true;
      localStorage.setItem("isAdmin", "true");
      updateAdminPanelVisibility();
      toast("‚úÖ Admin logged in");
    } else {
      alert("‚ùå Wrong password");
    }
  });
}

// In logoutAdmin():
function logoutAdmin() {
  localStorage.removeItem("isAdmin");
  isAdmin = false;
  updateAdminPanelVisibility();
}

let roomsCache = [];
let selectedRoomId = null;
let bedsListeners = {};

function listenToRoomChanges() {
  db.collection("rooms")
    .onSnapshot(snapshot => {
      roomsCache = [];
      snapshot.forEach(roomDoc => {
        const roomId = roomDoc.id;
        const roomData = roomDoc.data();
        roomsCache.push({ id: roomId, ...roomData });
      });

      // Sort alphabetically (case-insensitive)
      roomsCache.sort((a, b) => a.id.localeCompare(b.id, undefined, { sensitivity: 'base' }));

      const roomList = document.getElementById("roomList");
      roomList.innerHTML = '';
      let firstRoomId = null;

      roomsCache.forEach(room => {
        const btn = document.createElement("button");
        btn.textContent = room.id;
        btn.onclick = () => selectRoom(room.id);
        btn.className = "room-btn" + (room.id === selectedRoomId ? " selected" : "");
        roomList.appendChild(btn);
        if (!firstRoomId) firstRoomId = room.id;
      });

      // Mobile dropdown
      updateMobileDropdown();

      // Select current room or first
      if (!selectedRoomId || !roomsCache.some(r => r.id === selectedRoomId)) {
        selectedRoomId = firstRoomId;
      }
      if (selectedRoomId) {
        selectRoom(selectedRoomId, true);
      } else {
        renderRoomView(null, null, []);
      }
    });
}

function updateMobileDropdown() {
  const mobileSelectDiv = document.getElementById("mobileRoomSelect");
  const dropdown = document.getElementById("mobileRoomDropdown");
  dropdown.innerHTML = "";
  roomsCache.forEach(room => {
    const opt = document.createElement("option");
    opt.value = room.id;
    opt.textContent = room.id;
    dropdown.appendChild(opt);
  });
  dropdown.value = selectedRoomId || "";
  // Show/hide based on media query
  if (window.innerWidth < 750) {
    mobileSelectDiv.style.display = "block";
  } else {
    mobileSelectDiv.style.display = "none";
  }
}
window.addEventListener("resize", updateMobileDropdown);

function selectRoom(roomId, skipPush) {
  if (!roomId) return;
  selectedRoomId = roomId;
  updateMobileDropdown();
  document.querySelectorAll(".room-list button").forEach(btn =>
    btn.classList.toggle("selected", btn.textContent === roomId)
  );
  // Unsubscribe old
  for (let key in bedsListeners) {
    bedsListeners[key]();
    delete bedsListeners[key];
  }
  // Find room data
  const room = roomsCache.find(r => r.id === roomId);
  if (!room) {
    renderRoomView(null, null, []);
    return;
  }
  bedsListeners[roomId] = db.collection("rooms").doc(roomId).collection("beds")
    .onSnapshot(bedsSnapshot => {
      const beds = bedsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      renderRoomView(roomId, room, beds);
    });
}
function renderRoomView(roomId, roomData, beds) {
  const main = document.getElementById("mainArea");
  if (!roomId || !roomData) {
    main.innerHTML = "<div style='text-align:center;margin-top:40px;color:#666;'>No room selected</div>";
    return;
  }
  const occupied = beds.filter(b => b.notes).length;
  let html = `
    <div class="room-view">
      <div class="room-header-title">${roomId}</div>
      <div class="room-header-desc">${roomData.description || ""}</div>
      <div class="room-header-info">
        <strong>${beds.length}</strong> beds ‚Äî <strong>${occupied}</strong> occupied
      </div>
      <div class="beds-area"></div>
    </div>
  `;
  main.innerHTML = html;
  const bedsArea = main.querySelector(".beds-area");
  beds.forEach((bed, index) => {
    const bedDiv = document.createElement("div");
    bedDiv.className = "bed";
    bedDiv.style.borderLeftColor = bed.color && bed.color !== "none" ? bed.color : "#ccc";
    bedDiv.innerHTML = `
      ${isAdmin ? `<button class="remove-bed-btn" onclick="removeBed('${roomId}', '${bed.id}')">&times;</button>` : ""}
    <strong class="bed-title">Bed ${index + 1}</strong>
      <div style="margin-top:6px">
        <label>Status:</label>
        <input value="${bed.status || 'Empty'}" readonly disabled />
      </div>
      <div>
        <label>Notes:</label>
        <input value="${bed.notes || ''}" placeholder="Notes" oninput="noteChanged(this)">
      </div>
      <div>
        <label>Color:</label>
        <select onchange="colorChanged(this)">
          <option value="">None</option>
          <option value="green" ${bed.color === "green" ? "selected" : ""}>Green</option>
          <option value="yellow" ${bed.color === "yellow" ? "selected" : ""}>Yellow</option>
          <option value="red" ${bed.color === "red" ? "selected" : ""}>Red</option>
        </select>
      </div>
      <div style="display: flex; gap: 8px; margin-top: 10px;">
        <button onclick="saveBed('${roomId}', '${bed.id}', this)">üíæ Save</button>
        <button onclick="clearBed('${roomId}', '${bed.id}', this)">‚ùå Clear</button>
      </div>
    `;
    bedsArea.appendChild(bedDiv);
  });
  if (isAdmin) {
    const btnBox = document.createElement("div");
    btnBox.className = "admin-buttons";
    const addBtn = document.createElement("button");
    addBtn.textContent = "‚ûï Add Bed";
    addBtn.onclick = () => addBed(roomId);
    btnBox.appendChild(addBtn);
    bedsArea.appendChild(btnBox);
  }
}

function noteChanged(input) {
  const bedDiv = input.closest('.bed');
  bedDiv.classList.add("changed");
  const statusInput = bedDiv.querySelector("input[readonly]");
  const colorSelect = bedDiv.querySelector("select");
  if (input.value.trim()) {
    if (statusInput.value === "Empty") statusInput.value = "Occupied";
    if (!colorSelect.value || colorSelect.value === "green") {
      colorSelect.value = "red";
      bedDiv.style.borderLeftColor = "red";
    }
  } else {
    statusInput.value = "Empty";
    colorSelect.value = "green";
    bedDiv.style.borderLeftColor = "green";
  }
}

function colorChanged(select) {
  const bedDiv = select.closest('.bed');
  bedDiv.classList.add("changed");
  bedDiv.style.borderLeftColor = select.value || "#ccc";
}

function addRoom() {
  const name = document.getElementById("newRoomName").value.trim();
  const desc = document.getElementById("newRoomDesc").value.trim();
  const count = parseInt(document.getElementById("newRoomBeds").value);
  if (!name || !count) return alert("Fill all room fields");
  db.collection("rooms").doc(name).set({ description: desc, beds_count: count }).then(() => {
    const promises = [];
    for (let i = 1; i <= count; i++) {
      const bedRef = db.collection("rooms").doc(name).collection("beds").doc();
      promises.push(
        bedRef.set({
          status: "Empty",
          notes: "",
          color: "none",
          created_at: firebase.firestore.FieldValue.serverTimestamp()
        })
      );
    }
    return Promise.all(promises);
  }).then(() => toast("‚úÖ Room created"));
}

function saveBed(roomId, bedId, btn) {
  const bedDiv = btn.closest('.bed');
  const notes = bedDiv.querySelector("input[placeholder='Notes']").value;
  const color = bedDiv.querySelector("select").value;
  const status = notes.trim() ? "Occupied" : "Empty";
  const bedTitle = bedDiv.querySelector("strong")?.innerText || "";
  const match = bedTitle.match(/Bed (\d+)/);
  const bedIndex = match ? Number(match[1]) : null;
  db.collection("rooms").doc(roomId).collection("beds").doc(bedId).update({
    status, notes, color
  }).then(() => {
    toast("‚úÖ Bed saved");
    bedDiv.classList.remove("changed");
    bedDiv.style.borderLeftColor = color || "#ccc";
    return db.collection("notifications").add({
      type: "update", roomId, bedId, bedIndex, notes, color, clientId,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  }).catch((err) => {
    console.error("Error saving bed:", err);
    toast("‚ùå Failed to save bed");
  });
}

function clearBed(roomId, bedId, btn) {
  if (!confirm("Clear this bed?")) return;
  const bedDiv = btn.closest('.bed');
  const bedTitle = bedDiv.querySelector("strong")?.innerText || "";
  const match = bedTitle.match(/Bed (\d+)/);
  const bedIndex = match ? Number(match[1]) : null;
  db.collection("rooms").doc(roomId).collection("beds").doc(bedId).update({
    status: "Empty", notes: "", color: "none"
  }).then(() => {
    toast("‚úÖ Bed cleared");
    bedDiv.querySelector("input[placeholder='Notes']").value = "";
    bedDiv.querySelector("input[readonly]").value = "Empty";
    bedDiv.querySelector("select").value = "green";
    bedDiv.style.borderLeftColor = "green";
    bedDiv.classList.remove("changed");
    return db.collection("notifications").add({
      type: "clear", roomId, bedId, bedIndex, clientId,
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });
  }).catch((err) => {
    console.error("Error clearing bed:", err);
    toast("‚ùå Failed to clear bed");
  });
}

function deleteRoom() {
  const name = document.getElementById("deleteRoomName").value.trim();
  if (!name || !confirm("Delete room " + name + "?")) return;
  db.collection("rooms").doc(name).collection("beds").get().then(snapshot => {
    const deletions = snapshot.docs.map(doc => doc.ref.delete());
    return Promise.all(deletions);
  }).then(() => db.collection("rooms").doc(name).delete()).then(() => toast("‚úÖ Room deleted"));
}

function removeBed(roomName, bedId) {
  if (!isAdmin) return;
  if (!confirm("Are you sure you want to delete this bed?")) return;
  const roomRef = db.collection("rooms").doc(roomName);
  roomRef.collection("beds").doc(bedId).delete()
    .then(() => roomRef.get())
    .then(doc => {
      const currentCount = doc.data().beds_count || 1;
      return roomRef.update({ beds_count: currentCount - 1 });
    }).then(() => toast("‚úÖ Bed removed"));
}

function addBed(roomName) {
  if (!isAdmin) return alert("Admin only");
  const roomRef = db.collection("rooms").doc(roomName);
  const bedsRef = roomRef.collection("beds");
  bedsRef.add({ status: "Empty", notes: "", color: "green" }).then(() => {
    return roomRef.get();
  }).then(doc => {
    const currentCount = doc.data().beds_count || 0;
    return roomRef.update({ beds_count: currentCount + 1 });
  }).then(() => toast("‚úÖ Bed added"));
}

function listenToNotifications() {
  db.collection("notifications")
    .orderBy("timestamp", "desc")
    .limit(1)
    .onSnapshot(snapshot => {
      snapshot.docChanges().forEach(change => {
        const notif = change.doc.data();
        if (notif.clientId === clientId) return; // Ignore self
        const bedLabel = notif.bedIndex ? `Bed ${notif.bedIndex}` : "Bed";
        if (notif.type === "clear") {
          toast(`üõèÔ∏è ${bedLabel} in ${notif.roomId} was cleared`);
        } else if (notif.type === "update") {
          toast(`üõèÔ∏è ${bedLabel} in ${notif.roomId} updated (${notif.notes || "no notes"})`);
        }
      });
    });
}

window.selectRoom = selectRoom;
window.noteChanged = noteChanged;
window.colorChanged = colorChanged;
window.saveBed = saveBed;
window.clearBed = clearBed;
window.addBed = addBed;
window.removeBed = removeBed;

window.onload = () => {
  listenToRoomChanges();
  listenToNotifications();
};

</script>
</body>
</html>
