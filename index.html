<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ICU Bed Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #f9f9f9; margin: 0; padding: 10px; }
    h1 { text-align: center; font-size: 22px; margin-bottom: 10px; }
    .room-container { display: flex; flex-wrap: wrap; gap: 15px; justify-content: center; }
    .room { background: white; border: 1px solid #ccc; border-radius: 8px; width: 100%; max-width: 350px; box-shadow: 2px 2px 8px rgba(0,0,0,0.1); overflow: hidden; }
    .room-header { cursor: pointer; background: #eee; padding: 10px; font-weight: bold; border-bottom: 1px solid #ccc; font-size: 18px; }
    .room-content { display: none; padding: 10px; font-size: 14px; }
    .bed {
        display: flex;
        flex-direction: column;
        border-left: 10px solid #ccc;
        padding: 10px;
        margin-bottom: 10px;
        background: #f0f0f0;
        border-radius: 5px;
        position: relative; /* ‚úÖ add this */
      }
    .bed input, .bed select { margin-top: 5px; padding: 6px; font-size: 14px; border: 1px solid #ccc; border-radius: 4px; }
    .bed button { margin-top: 5px; font-size: 14px; padding: 6px; cursor: pointer; border: none; border-radius: 4px; background: #007bff; color: white; }
    .bed button:hover { background: #0056b3; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); justify-content: center; align-items: center; z-index: 999; }
    .modal-content { background: white; padding: 20px; border-radius: 8px; max-width: 400px; width: 90%; }
    .modal input { display: block; margin-bottom: 10px; width: 100%; padding: 8px; }
    .modal button { margin-top: 10px; padding: 8px; width: 100%; font-size: 16px; border-radius: 4px; border: none; background: #28a745; color: white; }
    .modal button:hover { background: #218838; }
    .admin-buttons { display: flex; gap: 5px; flex-direction: column; margin-top: 10px; }
  </style>
</head>
<body>

<h1>üè• ICU Bed Tracker <button onclick="document.getElementById('adminModal').style.display='flex'">‚öôÔ∏è Admin Panel</button></h1>

<div id="adminModal" class="modal">
  <div class="modal-content">
    <h3>Admin Panel</h3>
    <input type="password" id="adminPassInput" placeholder="Enter Admin Password">
    <div id="adminActions" style="display:none">
      <input type="text" id="newRoomName" placeholder="Room name">
      <input type="text" id="newRoomDesc" placeholder="Room description">
      <input type="number" id="newRoomBeds" placeholder="Number of beds">
      <button onclick="addRoom()">‚ûï Add Room</button>
      <hr>
      <input type="text" id="deleteRoomName" placeholder="Room to delete">
      <button onclick="deleteRoom()">‚ùå Delete Room</button>
      <hr>
      <button onclick="logoutAdmin()">Logout</button>
    </div>
    <button onclick="verifyPassword()">Login</button>
    <button onclick="document.getElementById('adminModal').style.display='none'">Close</button>
  </div>
</div>

<div class="room-container" id="rooms"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAhoL_pZudfm53_6tuzgoCGsWOagL6AjZ8",
  authDomain: "icubedtracker.firebaseapp.com",
  projectId: "icubedtracker",
  storageBucket: "icubedtracker.appspot.com",
  messagingSenderId: "237624609130",
  appId: "1:237624609130:web:0f39d97d24443907f1bd13"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let isAdmin = false;

if (localStorage.getItem("isAdmin") === "true") {
  isAdmin = true;
  document.addEventListener("DOMContentLoaded", () => {
    document.getElementById("adminActions").style.display = "block";
  });
}

function verifyPassword() {
  const input = document.getElementById("adminPassInput").value;
  db.collection("config").doc("admin").get().then(doc => {
    if (input === doc.data()?.password) {
      isAdmin = true;
      localStorage.setItem("isAdmin", "true");
      document.getElementById("adminActions").style.display = "block";
      document.getElementById("adminModal").style.display = "none";
    } else alert("‚ùå Wrong password");
  });
}

function logoutAdmin() {
  localStorage.removeItem("isAdmin");
  location.reload();
}

function loadRooms() {
  db.collection("rooms").get().then(snapshot => {
    snapshot.forEach(doc => {
      const roomId = doc.id;
      const data = doc.data();
      db.collection("rooms").doc(roomId).collection("beds").get().then(bedSnap => {
        const beds = [];
        bedSnap.forEach(b => beds.push({ id: b.id, ...b.data() }));
        renderRoom(roomId, data.description, beds);
      });
    });
  });
}

function renderRoom(name, desc, beds) {
  const div = document.createElement("div");
  div.className = "room";
  div.innerHTML = `<div class="room-header">${name}</div><div class="room-content"><p>${desc || ''}</p></div>`;
  const content = div.querySelector(".room-content");
  div.querySelector(".room-header").onclick = () => {
    content.style.display = content.style.display === "none" ? "block" : "none";
  };
  beds.forEach((bed, index) => {
    const bedDiv = document.createElement("div");
    bedDiv.className = "bed";
    bedDiv.style.borderLeftColor = bed.color || "#ccc";
    bedDiv.innerHTML = `
        ${isAdmin ? `<span onclick="removeBed('${name}', '${bed.id}')" style="position:absolute; top:5px; right:10px; cursor:pointer; color:red; font-weight:bold;">‚ùå</span>` : ''}
        <strong>Bed ${index + 1}</strong>
        <input value="${bed.status}" readonly disabled />
        <input value="${bed.notes}" placeholder="Notes" oninput="noteChanged(this)">
        <select onchange="colorChanged(this)">
          <option value="">None</option>
          <option value="green" ${bed.color === "green" ? 'selected' : ''}>Green</option>
          <option value="yellow" ${bed.color === "yellow" ? 'selected' : ''}>Yellow</option>
          <option value="red" ${bed.color === "red" ? 'selected' : ''}>Red</option>
        </select>
        <button onclick="saveBed('${name}', '${bed.id}', this)">üíæ Save</button>
        <button onclick="clearBed('${name}', '${bed.id}', this)">‚ùå Clear</button>
      `;
    content.appendChild(bedDiv);
  });
  if (isAdmin) {
    const btnBox = document.createElement("div");
    btnBox.className = "admin-buttons";
    const addBtn = document.createElement("button");
    addBtn.textContent = "‚ûï Add Bed";
    addBtn.onclick = () => addBed(name);
    btnBox.appendChild(addBtn);
    content.appendChild(btnBox);
  }
  document.getElementById("rooms").appendChild(div);
}

function noteChanged(input) {
  const parent = input.parentElement;
  const status = parent.children[1];
  const color = parent.children[3];
  if (input.value.trim()) {
    status.value = "Occupied";
    color.value = "red";
    parent.style.borderLeftColor = "red";
  } else {
    status.value = "Empty";
    color.value = "green";
    parent.style.borderLeftColor = "green";
  }
}

function colorChanged(select) {
  select.parentElement.style.borderLeftColor = select.value || "#ccc";
}

function saveBed(roomId, bedId, btn) {
  const parent = btn.parentElement;
  const status = parent.children[1].value;
  const notes = parent.children[2].value;
  const color = parent.children[3].value;
  db.collection("rooms").doc(roomId).collection("beds").doc(bedId).set({ status, notes, color })
    .then(() => {
      btn.innerText = "‚úÖ Saved";
      setTimeout(() => btn.innerText = "üíæ Save", 1500);
    });
}

function clearBed(roomId, bedId, btn) {
  if (!confirm("Clear this bed?")) return;
  db.collection("rooms").doc(roomId).collection("beds").doc(bedId).set({ status: "Empty", notes: "", color: "green" })
    .then(() => location.reload());
}

function addRoom() {
  const name = document.getElementById("newRoomName").value.trim();
  const desc = document.getElementById("newRoomDesc").value.trim();
  const count = parseInt(document.getElementById("newRoomBeds").value);
  if (!name || !count) return alert("Fill all room fields");
  db.collection("rooms").doc(name).set({ description: desc, beds_count: count }).then(() => {
    const promises = [];
    for (let i = 1; i <= count; i++) {
      const bedRef = db.collection("rooms").doc(name).collection("beds").doc();
      promises.push(bedRef.set({ status: "Empty", notes: "", color: "green" }));
    }
    return Promise.all(promises);
  }).then(() => location.reload());
}

function deleteRoom() {
  const name = document.getElementById("deleteRoomName").value.trim();
  if (!name || !confirm("Delete room " + name + "?")) return;
  db.collection("rooms").doc(name).collection("beds").get().then(snapshot => {
    const deletions = snapshot.docs.map(doc => doc.ref.delete());
    return Promise.all(deletions);
  }).then(() => db.collection("rooms").doc(name).delete()).then(() => location.reload());
}
  
function removeBed(roomName, bedId) {
  if (!isAdmin) return;
  if (!confirm("Are you sure you want to delete this bed?")) return;
  const roomRef = db.collection("rooms").doc(roomName);
  roomRef.collection("beds").doc(bedId).delete()
    .then(() => roomRef.get())
    .then(doc => {
      const currentCount = doc.data().beds_count || 1;
      return roomRef.update({ beds_count: currentCount - 1 });
    })
    .then(() => location.reload());
}
  
function addBed(roomName) {
  if (!isAdmin) return alert("Admin only");
  const roomRef = db.collection("rooms").doc(roomName);
  const bedsRef = roomRef.collection("beds");
  bedsRef.add({ status: "Empty", notes: "", color: "green" }).then(() => {
    return roomRef.get();
  }).then(doc => {
    const currentCount = doc.data().beds_count || 0;
    return roomRef.update({ beds_count: currentCount + 1 });
  }).then(() => location.reload());
}

function deleteBedByIndex() {
  const room = document.getElementById("roomToModify").value.trim();
  const bedIndex = parseInt(document.getElementById("bedToDeleteIndex").value);
  if (!room || isNaN(bedIndex) || bedIndex < 1) return alert("‚ùå Please enter a valid room and bed number (starting from 1).");
  db.collection("rooms").doc(room).collection("beds").get()
    .then(snapshot => {
      const beds = snapshot.docs;
      if (bedIndex > beds.length) return alert(`‚ùå Bed ${bedIndex} does not exist in room ${room}.`);
      const bedDoc = beds[bedIndex - 1];
      return bedDoc.ref.delete().then(() => {
        return db.collection("rooms").doc(room).get().then(doc => {
          const count = doc.data().beds_count || beds.length;
          return db.collection("rooms").doc(room).update({ beds_count: count - 1 });
        });
      });
    }).then(() => location.reload()).catch(e => {
      console.error("Delete failed", e);
      alert("‚ùå Failed to delete bed");
    });
}

window.onload = loadRooms;
</script>

</body>
</html>
