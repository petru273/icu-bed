<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>ICU Bed Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="data:,">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f9f9f9;
      margin: 20px;
    }
    h1 { text-align: center; }
    .room-container { display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; }
    .room {
      background: white;
      border: 1px solid #ccc;
      border-radius: 8px;
      width: 300px;
      flex: 1 1 300px;
      box-shadow: 2px 2px 8px rgba(0,0,0,0.1);
      overflow: hidden;
    }
    .room-header { cursor: pointer; background: #eee; padding: 10px; font-weight: bold; border-bottom: 1px solid #ccc; }
    .room-content { display: none; padding: 10px; }
    .bed { display: flex; flex-direction: column; border-left: 10px solid #ccc; padding: 10px; margin-bottom: 10px; background: #f0f0f0; border-radius: 5px; }
    .bed input, .bed select { margin-top: 5px; padding: 4px; font-size: 14px; }
    .bed button { margin-top: 5px; font-size: 13px; padding: 5px 8px; cursor: pointer; }
    .admin-panel { margin-top: 20px; text-align: center; }
    .admin-panel input { margin: 5px; padding: 5px; }
    .hidden { display: none; }
    .error { color: red; font-weight: bold; }
  </style>
</head>
<body>

<h1>üè• ICU Bed Tracker</h1>
<div class="admin-panel">
  <button onclick="toggleAdmin()">‚öôÔ∏è Admin Panel</button>
  <div id="adminControls" class="hidden">
    <p><input type="password" id="adminPassInput" placeholder="Enter Admin Password"> <button onclick="verifyPassword()">Login</button></p>
    <div id="adminActions" class="hidden">
      <input type="text" id="newRoomName" placeholder="Room name">
      <button onclick="addRoom()">‚ûï Add Room</button>
      <input type="text" id="deleteRoomName" placeholder="Room to delete">
      <button onclick="deleteRoom()">‚ùå Delete Room</button>
    </div>
  </div>
</div>

<div class="room-container" id="rooms"></div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAhoL_pZudfm53_6tuzgoCGsWOagL6AjZ8",
  authDomain: "icubedtracker.firebaseapp.com",
  projectId: "icubedtracker",
  storageBucket: "icubedtracker.firebasestorage.app",
  messagingSenderId: "237624609130",
  appId: "1:237624609130:web:0f39d97d24443907f1bd13"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let isAdmin = false;

function toggleAdmin() {
  document.getElementById("adminControls").classList.toggle("hidden");
}

async function verifyPassword() {
  const input = document.getElementById("adminPassInput").value;
  const doc = await db.collection("config").doc("admin").get();
  const savedPass = doc.data()?.password;
  if (input === savedPass) {
    isAdmin = true;
    document.getElementById("adminActions").classList.remove("hidden");
    alert("‚úÖ Access granted");
  } else {
    alert("‚ùå Wrong password");
  }
}

function loadRooms() {
  db.collection("rooms").get().then(snapshot => {
    snapshot.forEach(doc => renderRoom(doc.id, doc.data()));
  });
}

function renderRoom(roomName, data) {
  const container = document.getElementById("rooms");
  const div = document.createElement("div");
  div.className = "room";
  div.innerHTML = `<div class="room-header">${roomName}</div><div class="room-content"></div>`;
  const content = div.querySelector(".room-content");
  div.querySelector(".room-header").onclick = () => {
    content.style.display = content.style.display === "none" ? "block" : "none";
  };
  (data.beds || []).forEach((bed, index) => {
    const bedDiv = document.createElement("div");
    bedDiv.className = "bed";
    bedDiv.style.borderLeftColor = bed.color || "#ccc";
    bedDiv.innerHTML = `
      <strong>Bed ${index + 1}</strong>
      <input value="${bed.status}" readonly disabled />
      <input value="${bed.notes}" placeholder="Notes" oninput="noteChanged(this)">
      <select onchange="colorChanged(this)">
        <option value="">None</option>
        <option value="green" ${bed.color==="green"?'selected':''}>Green</option>
        <option value="yellow" ${bed.color==="yellow"?'selected':''}>Yellow</option>
        <option value="red" ${bed.color==="red"?'selected':''}>Red</option>
      </select>
      <button onclick="saveBed('${roomName}', ${index}, this)">üíæ Save</button>
      <button onclick="clearBed('${roomName}', ${index}, this)">‚ùå Clear</button>
    `;
    content.appendChild(bedDiv);
  });
  if (isAdmin) {
    const addBtn = document.createElement("button");
    addBtn.textContent = "‚ûï Add Bed";
    addBtn.onclick = () => addBed(roomName);
    content.appendChild(addBtn);
    const delBtn = document.createElement("button");
    delBtn.textContent = "‚ùå Delete Last Bed";
    delBtn.onclick = () => removeBed(roomName);
    content.appendChild(delBtn);
  }
  container.appendChild(div);
}

function noteChanged(input) {
  const parent = input.parentElement;
  const status = parent.children[1];
  const color = parent.children[3];
  if (input.value.trim()) {
    status.value = "Occupied";
    color.value = "red";
    parent.style.borderLeftColor = "red";
  } else {
    status.value = "Empty";
    color.value = "green";
    parent.style.borderLeftColor = "green";
  }
}

function colorChanged(select) {
  select.parentElement.style.borderLeftColor = select.value || "#ccc";
}

function saveBed(room, index, btn) {
  const parent = btn.parentElement;
  const status = parent.children[1].value;
  const notes = parent.children[2].value;
  const color = parent.children[3].value;
  db.collection("rooms").doc(room).get().then(doc => {
    const beds = doc.data().beds;
    beds[index] = { status, notes, color };
    return db.collection("rooms").doc(room).set({ beds });
  }).then(() => {
    btn.innerText = "‚úÖ Saved";
    setTimeout(() => btn.innerText = "üíæ Save", 1500);
  });
}

function clearBed(room, index, btn) {
  if (!confirm("Clear this bed?")) return;
  const parent = btn.parentElement;
  parent.children[1].value = "Empty";
  parent.children[2].value = "";
  parent.children[3].value = "green";
  parent.style.borderLeftColor = "green";
  saveBed(room, index, btn);
}

function addBed(room) {
  db.collection("rooms").doc(room).get().then(doc => {
    const beds = doc.data().beds;
    beds.push({ status: "Empty", notes: "", color: "green" });
    return db.collection("rooms").doc(room).set({ beds });
  }).then(() => location.reload());
}

function removeBed(room) {
  if (!confirm("Remove last bed from " + room + "?")) return;
  db.collection("rooms").doc(room).get().then(doc => {
    const beds = doc.data().beds;
    beds.pop();
    return db.collection("rooms").doc(room).set({ beds });
  }).then(() => location.reload());
}

function addRoom() {
  const name = document.getElementById("newRoomName").value.trim();
  if (!name) return alert("Enter room name");
  db.collection("rooms").doc(name).set({ beds: [] }).then(() => location.reload());
}

function deleteRoom() {
  const name = document.getElementById("deleteRoomName").value.trim();
  if (!name || !confirm("Delete room " + name + "?")) return;
  db.collection("rooms").doc(name).delete().then(() => location.reload());
}

window.onload = loadRooms;
</script>

</body>
</html>
